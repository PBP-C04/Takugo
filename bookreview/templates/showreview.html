{% extends 'base.html' %}

<style>
    .alert {
        margin-top: 10px;
    }
</style>

{% block meta %}
<title>Book Review</title>
{% endblock meta %}

{% block content %}
<div class="container">
    <h1>Welcome, {{ name }}</h1>
    <h2>Here's some review for {{ book_to_review.title }}</h2>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-text">{{ book_to_review.title }} had {{ data_count }} review</h5>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="item-cards"></div>

    {% if user_status == 'U' %}
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" id="addReviewButton">Add Review</button>
    {% endif %}
</div>

</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">{{ book_to_review.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comment:</label>
                        <textarea class="form-control" id="comment" name="comment" autocomplete="off"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="rating" class="form-label">Rating:</label>
                        <input type="range" class="form-control" id="rating" name="rating" min="1" max="5" value="1">
                        <output for="rating" id="ratingValue">1</output>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="button_add" data-bs-dismiss="modal">Add Review</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <h3>Reviews</h3>
    <div class="card">
        <div class="card-body">
            <ul class="list-group" id="review_list"></ul>
        </div>
    </div>
</div>

<!-- Modal for Delete Review Confirmation -->
<div class="modal fade" id="deleteReviewConfirmationModal" tabindex="-1" aria-labelledby="deleteReviewConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReviewConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this review?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteReviewButton">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Unauthorized Deletion -->
<div class="modal fade" id="unauthorizedDeleteModal" tabindex="-1" aria-labelledby="unauthorizedDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unauthorizedDeleteModalLabel">Unauthorized Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Sorry, you are not authorized to delete this review.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Guest Warning -->
<div class="modal fade" id="guestWarningModal" tabindex="-1" aria-labelledby="guestWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guestWarningModalLabel">Guest Warning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Guests are not allowed to delete reviews.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    var book_id="{{ book_to_review.pk }}";
    var userType = "{{ user_status }}";

    async function getReview() {
        return fetch("{% url 'bookreview:review_json' book_id=0 %}".replace("0", book_id)).then((res) => res.json());
    }

    async function refreshReview() {
        const reviewList = document.getElementById("review_list");
        reviewList.innerHTML = "";

        const reviews = await getReview();

        reviews.forEach((review) => {
            const listItem = document.createElement("li");
            listItem.classList.add("list-group-item");
            listItem.innerHTML = `
                <h5>${review.fields.comment}</h5>
                <p>Rating: ${review.fields.rating}</p>
                <p>Posted at ${review.fields.date_added}</p>
                <button class="btn btn-danger" onclick="deleteReview(${review.pk})">Delete Review</button>
            `;
            reviewList.appendChild(listItem);
        });

        const reviewCount = reviews.length;
    
        const reviewCountElement = document.getElementById("review_count");
        reviewCountElement.textContent = `${book_to_review.title} had ${reviewCount} reviews`; // Menampilkan jumlah ulasan
    }

    function addReview() {
        fetch("{% url 'bookreview:add_review' book_id=0 %}".replace("0", book_id), {
            method: "POST",
            body: new FormData(document.querySelector('#form'))
        }).then(() => {
            refreshReview();
            document.getElementById("form").reset();
        });
        return false;
    }

    function deleteReview(id) {
        if (userType === "U") {
            const deleteReviewConfirmationModal = new bootstrap.Modal(document.getElementById('deleteReviewConfirmationModal'));
            const unauthorizedDeleteModal = new bootstrap.Modal(document.getElementById('unauthorizedDeleteModal'));

            deleteReviewConfirmationModal.show();
            document.getElementById('confirmDeleteReviewButton').onclick = () => {
                fetch(`{% url 'bookreview:delete_review' 0 %}`.replace("0", id), {
                    method: "POST",
                    body: new FormData(document.querySelector('#form'))
                })
                .then(response => {
                    if (response.status === 200) {
                        refreshReview();
                        document.getElementById("form").reset();
                    } else if (response.status === 403) {
                        unauthorizedDeleteModal.show();
                    }
                })
                .catch(error => {
                    console.error("Error deleting review: " + error);
                })
                .finally(() => {
                    // Membersihkan semua modals
                    deleteReviewConfirmationModal.hide();
                    unauthorizedDeleteModal.hide();
                });
            };
        } else if (userType === "X") {
            const guestWarningModal = new bootstrap.Modal(document.getElementById('guestWarningModal'));
            guestWarningModal.show();
        }
    }

    var ratingInput = document.getElementById('rating');
    var ratingOutput = document.getElementById('ratingValue');

    // Memperbarui output saat input diubah
    ratingInput.addEventListener('input', function() {
        ratingOutput.textContent = ratingInput.value;
    });

    var userType = "{{ user_status }}";
    if (userType === "U") {
        document.getElementById("addReviewButton").style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", function () {
        var myModal = new bootstrap.Modal(document.getElementById('exampleModal'));
    });

    refreshReview();
    document.getElementById("button_add").onclick = addReview;
</script>


{% endblock content %}
